/*
	Script: jQuery.xdCloudTags.js
	Plug-in for jQuery to transform an ordinary tag cloud to the cloud with vertical and horizontal tags
	Author:
		Valeriy Chupurnov <leroy@xdan.ru>, <http://xdan.ru>
*/
(function($){var s=function(a,b){this.side=(!b)?'width':'height';this[this.side]=parseInt(a);this._y=(this.side=='width')?'y':'x';this._x=(this.side=='width')?'x':'y';this._w=(this.side=='width')?'w':'h'};var v=function(x,y,w,h){return{x:x,y:y,w:w,h:h,x1:function(){return this.x+this.w},y1:function(){return this.y+this.h},intersect:function(a){return((((a.x>=this.x&&a.x<=this.x1())||(a.x1()>=this.x&&a.x1()<=this.x1()))&&((a.y>=this.y&&a.y<=this.y1())||(a.y1()>=this.y&&a.y1()<=this.y1())))||(((this.x>=a.x&&this.x<=a.x1())||(this.x1()>=a.x&&this.x1()<=a.x1()))&&((this.y>=a.y&&this.y<=a.y1())||(this.y1()>=a.y&&this.y1()<=a.y1()))))||((((a.x>=this.x&&a.x<=this.x1())||(a.x1()>=this.x&&a.x1()<=this.x1()))&&((this.y>=a.y&&this.y<=a.y1())||(this.y1()>=a.y&&this.y1()<=a.y1())))||(((this.x>=a.x&&this.x<=a.x1())||(this.x1()>=a.x&&this.x1()<=a.x1()))&&((a.y>=this.y&&a.y<=this.y1())||(a.y1()>=this.y&&a.y1()<=this.y1()))))},}};s.prototype={width:0,height:0,side:'width',_x:'x',_y:'y',pack:[],findPlace:function(a){if(this.pack.length){var i=0;while(i<this.pack.length){if(a.intersect(this.pack[i])){if(1+a[this._w]+this.pack[i][this._x+'1']()<this[this.side]){a[this._x]=this.pack[i][this._x+'1']()+1;i=-1}else{a[this._y]+=1;a[this._x]=0;i=-1}}i++}}else{a.x=0;a.y=0};return a},fit:function(a){this.pack=[];for(var i=0;i<a.length;i++){this.pack.push(this.findPlace(a[i]))}}};var z=1;$.fn.xdCloudTags=function(n){var o={'invert':false,'rotate':true,'sort':true,'save':false,'newsave':false,'horizontal':false,};n=$.extend(o,n);var p=function(r,l,t,u){return{'rotate':r,'left':l,'top':t,}};var q=function(d,e,f){var g=function(a,b){return parseInt(a[e])*parseInt(a[f])>parseInt(b[e])*parseInt(b[f])};var b=d.slice(0,d.length/2).sort(g);var c=d.slice(d.length/2).sort(g).reverse();return b.concat(c)};return this.each(function(){var e=$(this);e.css('position','relative');var f=(e.attr('id')!==undefined)?e.attr('id'):'xdCloud-'+z++;var g=new s(e[n.horizontal?'height':'width'](),n.horizontal);var j=e.children();var k=[];var l={saved:false};if(n.save&&localStorage.getItem('xdBlocks'+f)&&!n.newsave)l=JSON.parse(localStorage.getItem('xdBlocks'+f));var i=1;j.each(function(){var a=$(this);var c=f+'-'+i++;a.attr('data-id',c);a.css({'position':'absolute',left:0,top:0});var w=parseInt(a.width()),h=parseInt(a.height());if(n.rotate){if((!l[c]&&Math.random()>0.5)||(l[c]&&l[c].rotate)){a.addClass('vertical'+(n.invert?'-invert':''));var b=w;w=h;h=b;a.css({'marginTop':parseInt(h/2)-parseInt(w/2),'marginBottom':parseInt(h/2)-parseInt(w/2),'marginLeft':parseInt(w/2)-parseInt(h/2),})}}var d=new v(0,0,w,h);d.elm=this;k.push(d)});if(!n.save||!l.saved){if(n.sort)k=q(k,'w','h');var m={};g.fit(k);$(g.pack).each(function(){var a=$(this.elm);a.css({'left':this.x,top:this.y});l[a.attr('data-id')]=p(a.hasClass('vertical')||a.hasClass('vertical-invert'),this.x,this.y)})}else{j.each(function(){var a=$(this).attr('data-id');if(l[a])$(this).css({'left':l[a].left,'top':l[a].top})})}if(n.save&&(!l['saved']||!n.newsave)){l['saved']=true;localStorage.setItem('xdBlocks'+f,JSON.stringify(l))}})}})(jQuery);